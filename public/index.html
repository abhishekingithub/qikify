<!--
 *
 * Attribution: heavily modified version of socket-chat, on github at:
 *  			https://github.com/arunjitsingh/socket-chat
 *
-->
<!DOCTYPE html>
<html manifest="app.manifest">
<head>
  	<title>Chat</title>
  	<link rel="stylesheet" type="text/css" href="css/main.css" />
	<link rel="stylesheet" type="text/css" href="css/Aristo/jquery-ui-1.8.7.custom.css" />
	<script type="text/javascript" src="javascripts/socket.io.js"></script>	
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script> 
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.7/jquery-ui.min.js"></script>
	<script type="text/javascript">
		io.setPath('/');
		if ('undefined'===typeof(io)) { throw new Error("Application failed to load: Socket.IO not found"); }
	  	var socket = new io.Socket("localhost", {port:9202});

		$(document).ready(function() {
			// Hide chat interface until after login.
			$("div#container").hide();
			$("#loginButton, #submitButton").button();

			// Login form submit calls init() to start the chat interface.
			$("#loginButton").click(function() { return init(); });
			$("#loginForm").submit( function() { return init(); });
			
			// Submit button / enter keypress submit the chat message.
			$("#submitButton").click(function() { return pushMsg(); });
			$('#imchat').submit(     function() { return pushMsg(); });
		});
		
		// This function grabs the username from the login box and sends a login
		// request message to the server. It also associates the pullMsg() handler
		// function with the websocket so that messages will be handled there.
		var init = function() {
			var username = $("#loginText").val();
			$("#login").fadeOut(function() { 
				$("div#container").show();
				$("#chats").scrollTop($("#chats")[0].scrollHeight); 
			});
		  	socket.on('message', pullMsg);
		  	socket.connect();
			socket.send("USERNAME:" + username);
			return false;
		};
		
		// This function pushes a message to the server from the chat box.
		var pushMsg = function() {
			var msg = $('#im').val();
		  	if (msg) {
				socket.send(msg);
		    	renderMsg({message:msg});
		  	}
			$('#im').val('');
		  	$('#im').focus();
			return false;
		};
		
		var pullMsg = function(data) {
		  if ("string"===typeof(data)) { data = JSON.parse(data); }
		  return renderMsg(data);
		};

		var renderMsg = function(data) {
			var renderMessage = function(message) {
				var username = (message.username) ? message.username : "me";
		    	return "<li class='chat'><span class='user'>" + username + ": </span>" + 
					   					"<span class='message'>" + message.message + "</span></li>";
		  	};
			
			// Just a single message
		  	if (data && data.message) {        
		    	$('#chats').append(renderMessage(data));
		  	}
			// Announcement
			else if (data && data.announcement) {
				$('#chats').append("<li class='information'>" + data.announcement + "</li>");
			} 
			// User list
			else if (data && data.userlist && data.userlist.length) {
				$('#chats').append("<li class='information'>Users: " + data.userlist.join(", ") + "</li>");
			}
			// Batch messages
			if (data && data.messages) {     
		    	for (var msg in data.messages) {
		    		$('#chats').append(renderMessage(data.messages[msg]));
		    	}
		  	}
			$("#chats").scrollTop($("#chats")[0].scrollHeight);
			return false;
		};
	</script>
</head>
<body>
	<h1>KuppDev Chat</h1>
	<div id="login">
		<form id="loginForm" action="">
			<label for="username" id="loginLabel">Please enter a username:</label>
	  		<input type="text" id="loginText" value="" />
			<div id="loginButton">Enter Chat</div>
		</form>
	</div>
	
  	<div id="container">
    	<ul id="chats">
    	</ul>
    	<form id="imchat">
      	<input type="text" id="im" value="" />	
		<div id="submitButton">Submit</div>
    	</form>
  	</div>
</body>
</html>