<!DOCTYPE html>
<html manifest="app.manifest">
<head>
  	<title>Chat</title>
  	<link rel="stylesheet" type="text/css" href="css/main.css" />
	<script src="javascripts/socket.io.js" type="text/javascript" charset="utf-8"></script>
	<script src="javascripts/jquery-1.5.1.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			io.setPath('/');
		  	if ('undefined'===typeof(io)) { throw new Error("Application failed to load: Socket.IO not found"); }
		  	var socket = new io.Socket("localhost", {port:9202});
		  	socket.on('message', didReceiveData);
		  	socket.connect();
			socket.send("USERNAME:booger"); 

			$('#imchat').submit(function() {
				var inputForm = $(this).children('#im');
				msg 	  	  = inputForm.val();
			  	if (msg) {
			    	socket.send(msg);
			    	renderChatData({message:msg});
			    	inputForm.value = "";
			  	}
				inputForm.val('');
			  	inputForm.focus();
				return false;
			});
			
		});
		
		var didReceiveData = function(data) {
		  if ("string"===typeof(data)) { data = JSON.parse(data); }
		  return renderChatData(data);
		};

		var renderChatData = function(data) {
			var renderMessage = function(message) {
				var user = "<span class='user'>me: " + "</span>";
		    	if (message.username) {
		    		user = "<span class='user'>" + message.username + ": " + "</span>";
		    	}
		    	return "<li class='chat'>" + user + 
					   "<span class='message'>" + message.message + "</span></li";
		  	};
			
		  	if (data && data.message) {        
		    	$('#chats').append(renderMessage(data));
		  	}	 
			else if (data && data.announcement) {
				$('#chats').append("<li class='information'>" + data.announcement + "</li>");
			} 
			else if (data && data.userlist && data.userlist.length) {
				$('#chats').append("<li class='information'>Users: " + data.userlist.join(", ") + "</li>");
			}
			if (data && data.messages) {     
		    	for (var msg in data.messages) {
		    		$('#chats').append(renderMessage(data.messages[msg]));
		    	}
		  	}
		};
	</script>

</head>
<body

  	<div id="container">
    	<ul id="chats">
    	</ul>
    	<form id="imchat">
      	<input type="text" id="im" value="">
    	</form>
  	</div>
</body>
</html>